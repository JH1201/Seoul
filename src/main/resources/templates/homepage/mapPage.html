<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ì„œìš¸ì€ ì§€ê¸ˆ</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="/mapPageCss/MapPageCss.css">

</head>
<body>


<div id="container">
    <div id="detail-toggleBtn">
        <div id="details" style="width: 400px">
            <h1>
                <a href="/home" style="text-decoration: none">ì„œìš¸ì€ ì§€ê¸ˆ</a>
            </h1>
            <h3>
                ì§€ë„ì— ìˆëŠ” í–‰ì‚¬ ë¦¬ìŠ¤íŠ¸
            </h3>
            <div id="eventsContainer">


                <div class="items-grid">
                    <div th:each="event : ${lists}" class="item" style="margin-bottom: 18px;">
                        <a th:href="@{/eventInfo(title=${event.getTITLE()})}">
                            <img th:src="${event.getMAIN_IMG()}" alt="Event Image" class="itemimg">
                        </a>
                        <div>
                            <h4 class="eventtitle" th:text="${event.getTITLE()}"></h4>
                            <p class="is-free" th:text="${event.getIS_FREE()}"></p>
                            <p class="eventdate" th:text="${event.getDATE()}"></p>
                            <p class="place" th:text="${event.getPLACE()}"></p>
                        </div>
                        <button class="event-location" type="submit" th:data-lat="${event.getLAT()}" th:data-lng="${event.getLOT()}">
                            <img src="/image/13807908.png" alt="ìœ„ì¹˜ë¡œë”©">
                        </button>
                    </div>

                    <div th:if="${lists == null || lists.isEmpty()}">
                        <p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>

            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    // eventTypeê³¼ locationName ì„¹ì…˜ì˜ ëª¨ë“  ì²´í¬ë°•ìŠ¤ ì²˜ë¦¬
                    document.querySelectorAll('.eventType input[type="checkbox"], .locationName input[type="checkbox"]').forEach(function(checkbox) {
                        checkbox.addEventListener('change', function() {
                            const parentDiv = this.closest('div'); // í˜„ì¬ ì²´í¬ë°•ìŠ¤ì˜ ë¶€ëª¨ div
                            const allCheckbox = parentDiv.querySelector('input[type="checkbox"][value="ì „ì²´"]'); // í˜„ì¬ ì„¹ì…˜ì˜ 'ì „ì²´' ì²´í¬ë°•ìŠ¤

                            if (this.value === "ì „ì²´") {
                                // 'ì „ì²´' ì²´í¬ë°•ìŠ¤ê°€ ì„ íƒëœ ê²½ìš°, ë‹¤ë¥¸ ëª¨ë“  ì²´í¬ë°•ìŠ¤ í•´ì œ
                                if (this.checked) {
                                    parentDiv.querySelectorAll('input[type="checkbox"]:not([value="ì „ì²´"])').forEach(cb => cb.checked = false);
                                }
                            } else {
                                // 'ì „ì²´'ê°€ ì•„ë‹Œ ì²´í¬ë°•ìŠ¤ ì„ íƒ ì‹œ 'ì „ì²´' ì²´í¬ë°•ìŠ¤ í•´ì œ
                                allCheckbox.checked = false;

                                // ë‹¤ë¥¸ ì²´í¬ë°•ìŠ¤ê°€ í•˜ë‚˜ë¼ë„ ì„ íƒëœ ê²½ìš° 'ì „ì²´' ì²´í¬ë°•ìŠ¤ ìœ ì§€ë¥¼ í•´ì œ
                                const anyChecked = Array.from(parentDiv.querySelectorAll('input[type="checkbox"]:not([value="ì „ì²´"])')).some(cb => cb.checked);
                                if (!anyChecked) {
                                    // ëª¨ë“  ì²´í¬ë°•ìŠ¤ê°€ í•´ì œë˜ë©´ 'ì „ì²´' ì²´í¬ë°•ìŠ¤ë¥¼ ìë™ìœ¼ë¡œ ì„ íƒí•˜ì§€ ì•ŠìŒ
                                    allCheckbox.checked = false;
                                }
                            }
                        });
                    });

                    // 'ì„ íƒ ì´ˆê¸°í™”' ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
                    document.getElementById('resetButton').addEventListener('click', function() {
                        document.querySelectorAll('.searchDownPart input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
                    });

                    document.getElementById('detailSearch').addEventListener('click', function(event) {
                        event.preventDefault();
                        var eventTypes = Array.from(document.querySelectorAll('.eventType input[type="checkbox"]:checked')).map(checkbox => checkbox.value).join(",");
                        var locations = Array.from(document.querySelectorAll('.locationName input[type="checkbox"]:checked')).map(checkbox => checkbox.value).join(",");
                        var keyword = document.querySelector('.search-bar').value.trim(); // í‚¤ì›Œë“œ ê²€ìƒ‰ì–´
                        var startDate = document.getElementById('date1').value; // ì‹œì‘ ë‚ ì§œ
                        var endDate = document.getElementById('date2').value; // ì¢…ë£Œ ë‚ ì§œ

                        fetch(`/mapSearchEvents?keyword=${encodeURIComponent(keyword)}&startDate=${startDate}&endDate=${endDate}&eventTypes=${eventTypes}&locations=${locations}`, {
                            headers: {
                                'Accept': 'application/json'
                            }
                        })
                            .then(response => response.json())
                            .then(data => {
                                updatePageWithFilteredEvents(data); // ê²€ìƒ‰ ê²°ê³¼ë¡œ UI ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
                                addMarkersToMap2(map, data);
                            })
                            .catch(error => console.error('Error:', error));
                    });


                    document.getElementById('searchForm').addEventListener('click', function(event) {
                        event.preventDefault();
                        var eventTypes = Array.from(document.querySelectorAll('.eventType input[type="checkbox"]:checked')).map(checkbox => checkbox.value).join(",");
                        var locations = Array.from(document.querySelectorAll('.locationName input[type="checkbox"]:checked')).map(checkbox => checkbox.value).join(",");
                        var keyword = document.querySelector('.search-bar').value.trim(); // í‚¤ì›Œë“œ ê²€ìƒ‰ì–´
                        var startDate = document.getElementById('date1').value; // ì‹œì‘ ë‚ ì§œ
                        var endDate = document.getElementById('date2').value; // ì¢…ë£Œ ë‚ ì§œ

                        fetch(`/mapSearchEvents?keyword=${encodeURIComponent(keyword)}&startDate=${startDate}&endDate=${endDate}&eventTypes=${eventTypes}&locations=${locations}`, {
                            headers: {
                                'Accept': 'application/json'
                            }
                        })
                            .then(response => response.json())
                            .then(data => {


                                updatePageWithFilteredEvents(data); // ê²€ìƒ‰ ê²°ê³¼ë¡œ UI ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
                                addMarkersToMap2(map, data);
                            })
                            .catch(error => console.error('Error:', error));
                    });

                    document.querySelectorAll('.event-location').forEach(function(button) {
                        button.addEventListener('click', function() {
                            const lat = this.getAttribute('data-lat');
                            const lng = this.getAttribute('data-lng');
                            moveToLocation(lat, lng);
                        });
                    });
                });
            </script>


        </div>

        <div class="toggleBTN">
            <button id="toggle-button">
                <img src="image/left-chevron.png" alt="Toggle Detail View" id="toggle-icon" />
            </button>

            <script>
                document.getElementById('toggle-button').addEventListener('click', function() {
                    var details = document.getElementById('details');
                    var button = document.getElementById('toggle-button');
                    var icon = document.getElementById('toggle-icon');
                    if (details.style.width === '400px') {
                        details.style.width = '0'; // ìƒì„¸ ì •ë³´ë¥¼ ì ‘ìŠµë‹ˆë‹¤.
                        button.style.left = '0'; // ë²„íŠ¼ì˜ ìœ„ì¹˜ë¥¼ ì¡°ì •í•©ë‹ˆë‹¤.
                        icon.src = "image/right-chevron.png";
                    } else {
                        details.style.width = '400px'; // ìƒì„¸ ì •ë³´ë¥¼ í¼ì¹©ë‹ˆë‹¤.
                        button.style.left = '400px'; // ë²„íŠ¼ì˜ ìœ„ì¹˜ë¥¼ ì›ë˜ëŒ€ë¡œ ëŒë¦½ë‹ˆë‹¤.
                        icon.src = "image/left-chevron.png";
                    }
                    setTimeout(function() {
                        map.relayout();
                        // í† ê¸€ í–ˆì„ ë•Œ ì˜¤ë¥¸ìª½ ë§µ ì§¤ë¦¬ëŠ” í˜„ìƒ í•´ê²°
                    }, 300); // 300ms í›„ì— ì‹¤í–‰
                });
            </script>
        </div>
    </div>

    <div class="map_wrap">
        <div id="map"></div>

        <div class="searchUpPart">
            <div class="dateSearch">
                <div class="date">
                    <label for="date1">
                        <input type="date" id="date1"></input>
                    </label>
                </div>
                <div class="date" style="display: flex; align-items: center; height: 60px;"> ~ </div>
                <div class="date">
                    <label for="date2">
                        <input type="date" id="date2" value="2024-12-31"></input>
                    </label>
                </div>

                <div style="margin-left:10px">
                    <form class="search-part" id="searchForm" action="/search" method="get">
                        <input type="text" name="keyword" class="search-bar" placeholder="í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.&#10;" >
                        <button class="search-button" type="submit">ğŸ”ï¸</button>
                    </form>
                </div>
            </div>


        </div>

        <script>
            // í˜„ì¬ ë‚ ì§œë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
            function getCurrentDate() {
                const today = new Date();
                const year = today.getFullYear();
                let month = today.getMonth() + 1;
                let day = today.getDate();

                // ì›”ê³¼ ì¼ì´ í•œ ìë¦¬ ìˆ«ìì¸ ê²½ìš° ì•ì— 0ì„ ì¶”ê°€í•´ì¤ë‹ˆë‹¤.
                if (month < 10) {
                    month = '0' + month;
                }
                if (day < 10) {
                    day = '0' + day;
                }

                return `${year}-${month}-${day}`;
            }

            // input ìš”ì†Œì˜ value ì†ì„±ì— í˜„ì¬ ë‚ ì§œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
            document.getElementById('date1').value = getCurrentDate();
        </script>

        <div class="custom_typecontrol radius_border">
            <span id="btnRoadmap" class="selected_btn" onclick="setMapType('roadmap')">ì§€ë„</span>
            <span id="btnSkyview" class="btn" onclick="setMapType('skyview')">ìŠ¤ì¹´ì´ë·°</span>
        </div>
        <!-- ì§€ë„ í™•ëŒ€, ì¶•ì†Œ ì»¨íŠ¸ë¡¤ div ì…ë‹ˆë‹¤ -->
        <div class="custom_zoomcontrol radius_border">
            <span onclick="zoomIn()"><img src="https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/ico_plus.png" alt="í™•ëŒ€"></span>
            <span onclick="zoomOut()"><img src="https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/ico_minus.png" alt="ì¶•ì†Œ"></span>
        </div>
        <ul id="category">
            <li id="SW8">
                <img src="image/128654.png">
                ì§€í•˜ì² ì—­
            </li>
            <li id="PK6">
                <img src="image/128655.png">
                ì£¼ì°¨ì¥
            </li>
        </ul>

        <!--<ul id="CurrentLocation">
            <li style="background: none">í˜„ì¬ ìœ„ì¹˜</li>
        </ul>-->

        <ul id="detailSearchToggle" onclick="changeBtnName()">
            ìƒì„¸ê²€ìƒ‰ ì—´ê¸° &#9660;
        </ul>

        <script>
            function changeBtnName() {
                const btnElement = document.getElementById('detailSearchToggle');
                if (btnElement.innerText.includes('ì—´ê¸°')) {
                    btnElement.innerText = 'ìƒì„¸ê²€ìƒ‰ ë‹«ê¸° â–²';
                } else {
                    btnElement.innerText = 'ìƒì„¸ê²€ìƒ‰ ì—´ê¸° â–¼';
                }
            }
        </script>

        <div id="popupDetail">
            <br>
            <div class="searchDownPart">
                <div class="eventType">
                    <input type="checkbox" id="select0" name="codename" value="ì „ì²´"><label for="select0" id="select0Label"> ì „ì²´</label>
                    <input type="checkbox" id="select1" name="codename" value="ë®¤ì§€ì»¬/ì˜¤í˜ë¼"><label for="select1" id="select1Label"> ë®¤ì§€ì»¬/ì˜¤í˜ë¼</label>
                    <input type="checkbox" id="select2" name="codename" value="ì—°ê·¹"><label for="select2" id="select2Label"> ì—°ê·¹</label>
                    <input type="checkbox" id="select3" name="codename" value="ë¬´ìš©"><label for="select3" id="select3Label"> ë¬´ìš©</label>
                    <input type="checkbox" id="select4" name="codename" value="êµ­ì•…"><label for="select4" id="select4Label"> êµ­ì•…</label>
                    <input type="checkbox" id="select5" name="codename" value="í´ë˜ì‹"><label for="select5" id="select5Label"> í´ë˜ì‹</label>
                    <input type="checkbox" id="select6" name="codename" value="ì „ì‹œ/ë¯¸ìˆ "><label for="select6" id="select6Label"> ì „ì‹œ/ë¯¸ìˆ </label>
                    <input type="checkbox" id="select7" name="codename" value="êµìœ¡/ì²´í—˜"><label for="select7" id="select7Label"> êµìœ¡/ì²´í—˜</label>
                    <input type="checkbox" id="select8" name="codename" value="ì½˜ì„œíŠ¸"><label for="select8" id="select8Label"> ì½˜ì„œíŠ¸</label>
                    <input type="checkbox" id="select9" name="codename" value="ì˜í™”"><label for="select9" id="select9Label"> ì˜í™”</label>
                    <input type="checkbox" id="select10" name="codename" value="ë…ì£¼/ë…ì°½íšŒ"><label for="select10" id="select10Label"> ë…ì£¼/ë…ì°½íšŒ</label>
                    <input type="checkbox" id="select11" name="codename" value="ì¶•ì œ"><label for="select11" id="select11Label"> ì¶•ì œ</label>
                    <input type="checkbox" id="select12" name="codename" value="ê¸°íƒ€"><label for="select12" id="select12Label"> ê¸°íƒ€</label>
                </div><br><br>

                <div class="locationName">
                    <input type="checkbox" id="location0" name="codename" value="ì „ì²´"><label for="location0" id="location0Label"> ì „ì²´</label>
                    <input type="checkbox" id="location1" name="codename" value="ê°•ë‚¨êµ¬"><label for="location1" id="location1Label"> ê°•ë‚¨êµ¬</label>
                    <input type="checkbox" id="location2" name="codename" value="ê°•ë™êµ¬"><label for="location2" id="location2Label"> ê°•ë™êµ¬</label>
                    <input type="checkbox" id="location3" name="codename" value="ê°•ë¶êµ¬"><label for="location3" id="location3Label"> ê°•ë¶êµ¬</label>
                    <input type="checkbox" id="location4" name="codename" value="ê°•ì„œêµ¬"><label for="location4" id="location4Label"> ê°•ì„œêµ¬</label>
                    <input type="checkbox" id="location5" name="codename" value="ê´€ì•…êµ¬"><label for="location5" id="location5Label"> ê´€ì•…êµ¬</label>
                    <input type="checkbox" id="location6" name="codename" value="ê´‘ì§„êµ¬"><label for="location6" id="location6Label"> ê´‘ì§„êµ¬</label>
                    <input type="checkbox" id="location7" name="codename" value="êµ¬ë¡œêµ¬"><label for="location7" id="location7Label"> êµ¬ë¡œêµ¬</label>
                    <input type="checkbox" id="location8" name="codename" value="ê¸ˆì²œêµ¬"><label for="location8" id="location8Label"> ê¸ˆì²œêµ¬</label>
                    <input type="checkbox" id="location9" name="codename" value="ë…¸ì›êµ¬"><label for="location9" id="location9Label"> ë…¸ì›êµ¬</label>
                    <input type="checkbox" id="location10" name="codename" value="ë„ë´‰êµ¬"><label for="location10" id="location10Label"> ë„ë´‰êµ¬</label>
                    <input type="checkbox" id="location11" name="codename" value="ë™ëŒ€ë¬¸êµ¬"><label for="location11" id="location11Label"> ë™ëŒ€ë¬¸êµ¬</label>
                    <input type="checkbox" id="location12" name="codename" value="ë™ì‘êµ¬"><label for="location12" id="location12Label"> ë™ì‘êµ¬</label>
                    <input type="checkbox" id="location13" name="codename" value="ë§ˆí¬êµ¬"><label for="location13" id="location13Label"> ë§ˆí¬êµ¬</label>
                    <input type="checkbox" id="location14" name="codename" value="ì„œëŒ€ë¬¸êµ¬"><label for="location14" id="location14Label"> ì„œëŒ€ë¬¸êµ¬</label>
                    <input type="checkbox" id="location15" name="codename" value="ì„œì´ˆêµ¬"><label for="location15" id="location15Label"> ì„œì´ˆêµ¬</label>
                    <input type="checkbox" id="location16" name="codename" value="ì„±ë™êµ¬"><label for="location16" id="location16Label"> ì„±ë™êµ¬</label>
                    <input type="checkbox" id="location17" name="codename" value="ì„±ë¶êµ¬"><label for="location17" id="location17Label"> ì„±ë¶êµ¬</label>
                    <input type="checkbox" id="location18" name="codename" value="ì†¡íŒŒêµ¬"><label for="location18" id="location18Label"> ì†¡íŒŒêµ¬</label>
                    <input type="checkbox" id="location19" name="codename" value="ì–‘ì²œêµ¬"><label for="location19" id="location19Label"> ì–‘ì²œêµ¬</label>
                    <input type="checkbox" id="location20" name="codename" value="ì˜ë“±í¬êµ¬"><label for="location20" id="location20Label"> ì˜ë“±í¬êµ¬</label>
                    <input type="checkbox" id="location21" name="codename" value="ìš©ì‚°êµ¬"><label for="location21" id="location21Label"> ìš©ì‚°êµ¬</label>
                    <input type="checkbox" id="location22" name="codename" value="ì€í‰êµ¬"><label for="location22" id="location22Label"> ì€í‰êµ¬</label>
                    <input type="checkbox" id="location23" name="codename" value="ì¢…ë¡œêµ¬"><label for="location23" id="location23Label"> ì¢…ë¡œêµ¬</label>
                    <input type="checkbox" id="location24" name="codename" value="ì¤‘êµ¬"><label for="location24" id="location24Label"> ì¤‘êµ¬</label>
                    <input type="checkbox" id="location25" name="codename" value="ì¤‘ë‘êµ¬"><label for="location25" id="location25Label"> ì¤‘ë‘êµ¬</label>

                </div><br><br>
                <div class="detailButton">
                    <button id="detailSearch"> ê²€ìƒ‰í•˜ê¸° </button>
                    <button id="resetButton"> ì„ íƒ ì´ˆê¸°í™” </button>
                </div>
            </div>


        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var popup = document.getElementById('popupDetail');
                popup.style.display = 'none'; // ì´ˆê¸°ì— íŒì—…ì„ ìˆ¨ê¹ë‹ˆë‹¤.
            });

            document.getElementById('detailSearchToggle').addEventListener('click', function() {
                var popup = document.getElementById('popupDetail');
                if (popup.style.display === 'none') {
                    popup.style.display = 'block'; // íŒì—…ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
                } else {
                    popup.style.display = 'none'; // íŒì—…ì„ ìˆ¨ê¹ë‹ˆë‹¤.
                }
            });

        </script>

    </div>

    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=33db73c119b1dea112b5e9038fd6ef2a&libraries=services,clusterer,drawing"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script th:inline="javascript">
        // ë§ˆì»¤ë¥¼ í´ë¦­í–ˆì„ ë•Œ í•´ë‹¹ ì¥ì†Œì˜ ìƒì„¸ì •ë³´ë¥¼ ë³´ì—¬ì¤„ ì»¤ìŠ¤í…€ì˜¤ë²„ë ˆì´ì…ë‹ˆë‹¤
        var placeOverlay = new kakao.maps.CustomOverlay({zIndex:1}),
            contentNode = document.createElement('div'), // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ì˜ ì»¨í…ì¸  ì—˜ë¦¬ë¨¼íŠ¸ ì…ë‹ˆë‹¤
            categorymarkers = [], // ë§ˆì»¤ë¥¼ ë‹´ì„ ë°°ì—´ì…ë‹ˆë‹¤
            currCategory = ''; // í˜„ì¬ ì„ íƒëœ ì¹´í…Œê³ ë¦¬ë¥¼ ê°€ì§€ê³  ìˆì„ ë³€ìˆ˜ì…ë‹ˆë‹¤

        // ì¹´ì¹´ì˜¤ë§µ API ì´ˆê¸°í™”
        var mapContainer = document.getElementById('map'), // ì§€ë„ë¥¼ í‘œì‹œí•  div
            mapOption = {
                center: new kakao.maps.LatLng(37.566535, 126.9779692), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
                level: 8, // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
                maxLevel: 8
            };

        let map = new kakao.maps.Map(mapContainer, mapOption);
        var ps = new kakao.maps.services.Places(map);
        function setMapType(maptype) {
            var roadmapControl = document.getElementById('btnRoadmap');
            var skyviewControl = document.getElementById('btnSkyview');
            if (maptype === 'roadmap') {
                map.setMapTypeId(kakao.maps.MapTypeId.ROADMAP);
                roadmapControl.className = 'selected_btn';
                skyviewControl.className = 'btn';
            } else {
                map.setMapTypeId(kakao.maps.MapTypeId.HYBRID);
                skyviewControl.className = 'selected_btn';
                roadmapControl.className = 'btn';
            }
        }
        function zoomIn() {
            map.setLevel(map.getLevel() - 1, {animate: true});
        }

        function zoomOut() {
            map.setLevel(map.getLevel() + 1, {animate: true});
        }

        var  cultureInfoList = [[${lists}]]; // í–‰ì‚¬ ì •ë³´ ë¦¬ìŠ¤íŠ¸
        var markersInfo = [];
        var markers = [];
        var currentMarker = null;
        var currentOverlay = null;
        var polygons = [];
        let customOverlay = new kakao.maps.CustomOverlay({});
        var polygonNames = new Map();

        $.getJSON("image/seoul.json", function(geojson) {
            var data = geojson.features;
            let coordinates = []; // ì¢Œí‘œ ì €ì¥ ë°°ì—´
            let name = ''; // êµ¬ ì´ë¦„

            $.each(data, function (index, val) {
                coordinates = val.geometry.coordinates;
                name = val.properties.SIG_KOR_NM;

                displayArea(coordinates, name);
            });

            addMarkersToMap(map, cultureInfoList);
        });

        function displayArea(coordinates, name) {
            var path = [];
            var points = [];

            $.each(coordinates[0], function(index, coordinate) {
                var point = new Object();
                point.x = coordinate[1];
                point.y = coordinate[0];
                points.push(point);
                path.push(new kakao.maps.LatLng(coordinate[1], coordinate[0]));
            })

            var polygon = new kakao.maps.Polygon({
                map: map,
                path: path,
                strokeWeight: 2,
                strokeColor : '#004c80',
                strokeOpacity : 0.8,
                fillColor : '#fff',
                fillOpacity : 0.7
            });
            polygons.push(polygon);
            polygonNames.set(polygon, name);

            kakao.maps.event.addListener(polygon, 'mouseover', function(mouseEvent) {
                polygon.setOptions({ fillColor: '#09f' });
                //customOverlay.setContent('<div class="area">' + name + '</div>');
                customOverlay.setPosition(mouseEvent.latLng);
                customOverlay.setMap(map);
            });

            kakao.maps.event.addListener(polygon, 'mouseout', function() {
                polygon.setOptions({
                    fillColor: '#fff'
                });
                customOverlay.setMap(null);
            });

            kakao.maps.event.addListener(polygon,'click', function() {
                var level = map.getLevel()-2;
                map.setLevel(level, {anchor: centroid(points), animate: {
                        duration:350
                    }});
                deletePolygon(polygons);
            });

            kakao.maps.event.addListener(map, 'zoom_changed', function() {
                var level = map.getLevel();
                if (level >= 8) {
                    // í™•ëŒ€ ë ˆë²¨ì´ 8 ì´ìƒì¼ ë•Œ
                    hideMarkers(); // ëª¨ë“  ë§ˆì»¤ ìˆ¨ê¸°ê¸°
                    displayPolygonsWithCount(); // í´ë¦¬ê³¤ê³¼ ë§ˆì»¤ ìˆ˜ í‘œì‹œ
                } else {
                    // í™•ëŒ€ ë ˆë²¨ì´ 8 ë¯¸ë§Œì¼ ë•Œ
                    showMarkers(); // ë§ˆì»¤ í‘œì‹œ
                    hidePolygons(); // í´ë¦¬ê³¤ ìˆ¨ê¸°ê¸°
                }
            });

        }

        function hideMarkers() {
            markers.forEach(marker => marker.setMap(null));
        }

        function showMarkers() {
            markers.forEach(marker => marker.setMap(map));
        }

        function hidePolygons() {
            polygons.forEach(polygon => {
                polygon.setMap(null);
                if (polygon.label) {
                    polygon.label.setMap(null); // ë ˆì´ë¸”ì´ ìˆìœ¼ë©´ ìˆ¨ê¹ë‹ˆë‹¤.
                    polygon.label = null; // ë ˆì´ë¸” ì°¸ì¡°ë¥¼ ì œê±°í•©ë‹ˆë‹¤.
                }
            });
        }

        function displayPolygonsWithCount() {
            var level = map.getLevel();
            if (level < 8) {
                hidePolygons(); // í™•ëŒ€ ë ˆë²¨ì´ 8 ì´í•˜ì¸ ê²½ìš°, ëª¨ë“  í´ë¦¬ê³¤ê³¼ ë ˆì´ë¸”ì„ ìˆ¨ê¹ë‹ˆë‹¤.
                return; // í•¨ìˆ˜ ì‹¤í–‰ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.
            }
            hideMarkers();
            polygons.forEach(function(polygon) {
                var name = polygonNames.get(polygon); // í´ë¦¬ê³¤ ê°ì²´ë¡œë¶€í„° ì´ë¦„ì„ ì¡°íšŒ
                var count = 0;
                markersInfo.forEach(function(markerInfo) {
                    if (markerInfo.guname === name) {
                        count++; // ê°™ì€ êµ¬ ì´ë¦„ì´ë©´ ì¹´ìš´íŠ¸ ì¦ê°€
                    }
                });
                polygon.setMap(map); // í´ë¦¬ê³¤ í‘œì‹œ

                var color = '#599468'; // ê¸°ë³¸ ìƒ‰ìƒ
                if (count >= 40) {
                    color = '#F05650'; // ë¹¨ê°„ìƒ‰
                } else if (count >= 20) {
                    color = '#FFD400'; // ë…¸ë€ìƒ‰
                }

                var content = `<div style="padding:5px; background: radial-gradient(circle, ${color}, transparent); color: white; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; flex-direction: column; border-radius: 50%;">
                    <div style="font-size: 15px; font-weight: bold; text-shadow: -2px 0 #444444, 0 2px #444444, 2px 0 #444444, 0 -2px #444444;">${name}</div>
                    <div style="font-size: 15px; font-weight: bold; margin-top: 5px; text-shadow: -2px 0 #444444, 0 2px #444444, 2px 0 #444444, 0 -2px #444444;">${count}</div>
                </div>
                `;

                // ë ˆì´ë¸” ì—…ë°ì´íŠ¸ ë˜ëŠ” ìƒì„±
                if (polygon.label) {
                    polygon.label.setContent(content);
                    polygon.label.setMap(map);
                } else {
                    var overlay = new kakao.maps.CustomOverlay({
                        content: content,
                        map: map,
                        position: centroidbypath(polygon.getPath())
                    });
                    polygon.label = overlay; // ìƒˆë¡œìš´ ë ˆì´ë¸”ì„ ìƒì„±í•˜ê³  í´ë¦¬ê³¤ì— ì°¸ì¡°ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
                }
            });

        }

        // í´ë¦¬ê³¤ ì¤‘ì‹¬ ê³„ì‚° í•¨ìˆ˜
        function centroid(points) {
            var i, j, len, p1, p2, f, area, x, y;
            area = x = y = 0;
            for(i = 0, len = points.length, j = len - 1; i < len; j = i++) {
                p1 = points[i];
                p2 = points[j];

                f = p1.y * p2.x - p2.y * p1.x;
                x += (p1.x + p2.x) * f;
                y += (p1.y + p2.y) * f;
                area += f * 3;
            }
            return new kakao.maps.LatLng(x/area, y/area);
        }

        function centroidbypath(path) {
            var x = 0, y = 0, len = path.length;
            path.forEach(function(coord) {
                x += coord.getLng();
                y += coord.getLat();
            });
            return new kakao.maps.LatLng(y / len, x / len);
        }

        function deletePolygon(polygons) {
            polygons.forEach(function(polygon) {
                polygon.setMap(null);
            });
            polygons = [];
        }


        function addMarkersToMap(map, cultureInfoList) {
            removeMarkers();
            markersInfo = cultureInfoList;
            // í˜„ì¬ ì§€ë„ì˜ ê²½ê³„ë¥¼ ê°€ì ¸ì˜´
            var bounds = map.getBounds();
            var southWest = bounds.getSouthWest(); // ë‚¨ì„œìª½ ì¢Œí‘œ
            var northEast = bounds.getNorthEast(); // ë¶ë™ìª½ ì¢Œí‘œ

            console.log(southWest);
            console.log(northEast);


            cultureInfoList.forEach(function(cultureInfo) {
                var lat = parseFloat(cultureInfo.lat);
                var lng = parseFloat(cultureInfo.lot);

                var position = new kakao.maps.LatLng(lng, lat);

                var marker = new kakao.maps.Marker({
                    map: map,
                    position: position
                });
                // ìƒˆë¡œìš´ ë§ˆì»¤ë¥¼ ë°°ì—´ì— ì¶”ê°€
                markers.push(marker);

                kakao.maps.event.addListener(marker, 'click', function() {

                    var matchingEvents = cultureInfoList.filter(function(event) {
                        return parseFloat(event.lat) === lat && parseFloat(event.lot) === lng;
                    });
                    // í˜„ì¬ ë§ˆì»¤ê°€ ì´ì „ì— í´ë¦­ëœ ë§ˆì»¤ì™€ ë™ì¼í•˜ë©´ ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
                    if (currentMarker === marker && currentOverlay) {
                        currentOverlay.setMap(null);
                        currentMarker = null;
                        currentOverlay = null;
                    } else {
                        // ë‹¤ë¥¸ ë§ˆì»¤ë¥¼ í´ë¦­í–ˆì„ ë•Œ, ì´ì „ ì˜¤ë²„ë ˆì´ë¥¼ ìˆ¨ê¸°ê³  ìƒˆë¡œìš´ ì •ë³´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
                        if (currentOverlay) {
                            currentOverlay.setMap(null);
                            currentOverlay = null;
                        }

                        if (matchingEvents.length > 0) {
                            var containerHTML = '<div class="markerinfo-container">';
                            var eventsHTML = matchingEvents.map(function(event) {
                                var eventInfoUrl = `/eventInfo?title=${encodeURIComponent(event.title)}`;
                                return `<div class="markerinfo">
                            <a class="title" href="${eventInfoUrl}" target="_blank">${event.title}</a>
                            <span>${event.place}</span>
                        </div>`;
                            }).join('');
                            containerHTML += eventsHTML + '</div>';

                            var overlayPosition = new kakao.maps.LatLng(marker.getPosition().getLat(), marker.getPosition().getLng()); // ì˜¤ë²„ë ˆì´ ìœ„ì¹˜ ì¡°ì •

                            var overlay = new kakao.maps.CustomOverlay({
                                content: containerHTML,
                                map: map,
                                position: overlayPosition,
                                yAnchor: 1.2
                            });

                            currentOverlay = overlay;
                            currentMarker = marker;

                            requestAnimationFrame(() => {
                                var overlayContainer = document.querySelector('.markerinfo-container');
                                if (overlayContainer) {
                                    overlayContainer.addEventListener('wheel', function(event) {
                                        event.preventDefault();
                                        event.stopPropagation();
                                        this.scrollTop += event.deltaY * 2;
                                    }, { passive: false });
                                } else {
                                    console.error("The '.markerinfo-container' element was not found.");
                                }
                            });
                        }
                    }
                });

            });
            displayPolygonsWithCount();

        }

        function addMarkersToMap2(map, cultureInfoList) {
            removeMarkers(); // ê¸°ì¡´ ë§ˆì»¤ ì‚­ì œ
            markersInfo = cultureInfoList;

            // cultureInfoListê°€ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
            if (!cultureInfoList || cultureInfoList.length === 0) {
                // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œì™€ í™•ëŒ€ ë ˆë²¨ ì„¤ì •
                map.setCenter(new kakao.maps.LatLng(37.566535, 126.9779692));
                map.setLevel(7);
                return; // í•¨ìˆ˜ ì¢…ë£Œ
            }

            // í˜„ì¬ ì§€ë„ì˜ ê²½ê³„ë¥¼ ê°€ì ¸ì˜´
            var bounds = new kakao.maps.LatLngBounds();

            cultureInfoList.forEach(function(cultureInfo) {
                var lat = parseFloat(cultureInfo.lat);
                var lng = parseFloat(cultureInfo.lot);

                var position = new kakao.maps.LatLng(lng, lat);
                bounds.extend(position);

                var marker = new kakao.maps.Marker({
                    map: map,
                    position: position
                });
                // ìƒˆë¡œìš´ ë§ˆì»¤ë¥¼ ë°°ì—´ì— ì¶”ê°€
                markers.push(marker);
                kakao.maps.event.addListener(marker, 'click', function() {

                    var matchingEvents = cultureInfoList.filter(function(event) {
                        return parseFloat(event.lat) === lat && parseFloat(event.lot) === lng;
                    });
                    // í˜„ì¬ ë§ˆì»¤ê°€ ì´ì „ì— í´ë¦­ëœ ë§ˆì»¤ì™€ ë™ì¼í•˜ë©´ ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
                    if (currentMarker === marker && currentOverlay) {
                        currentOverlay.setMap(null);
                        currentMarker = null;
                        currentOverlay = null;
                    } else {
                        // ë‹¤ë¥¸ ë§ˆì»¤ë¥¼ í´ë¦­í–ˆì„ ë•Œ, ì´ì „ ì˜¤ë²„ë ˆì´ë¥¼ ìˆ¨ê¸°ê³  ìƒˆë¡œìš´ ì •ë³´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
                        if (currentOverlay) {
                            currentOverlay.setMap(null);
                            currentOverlay = null;
                        }

                        if (matchingEvents.length > 0) {
                            var containerHTML = '<div class="markerinfo-container2">';
                            var eventsHTML = matchingEvents.map(function(event) {
                                var eventInfoUrl = `/eventInfo?title=${encodeURIComponent(event.title)}`;
                                return `<div class="markerinfo2">
                            <a class="title" href="${eventInfoUrl}" target="_blank">${event.title}</a>
                            <span>${event.place}</span>
                        </div>`;
                            }).join('');
                            containerHTML += eventsHTML + '</div>';

                            var overlayPosition = new kakao.maps.LatLng(marker.getPosition().getLat(), marker.getPosition().getLng()); // ì˜¤ë²„ë ˆì´ ìœ„ì¹˜ ì¡°ì •

                            var overlay = new kakao.maps.CustomOverlay({
                                content: containerHTML,
                                map: map,
                                position: overlayPosition,
                                yAnchor: 1.2
                            });

                            currentOverlay = overlay;
                            currentMarker = marker;

                            requestAnimationFrame(() => {
                                var overlayContainer = document.querySelector('.markerinfo-container2');
                                if (overlayContainer) {
                                    overlayContainer.addEventListener('wheel', function(event) {
                                        event.preventDefault();
                                        event.stopPropagation();
                                        this.scrollTop += event.deltaY * 2;
                                    }, { passive: false });
                                } else {
                                    console.error("The '.markerinfo-container' element was not found.");
                                }
                            });
                        }
                    }
                });

            });

            map.setBounds(bounds);
            displayPolygonsWithCount();
        }


        function removeMarkers() {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(null);
            }
            markers = []; // ë§ˆì»¤ ë°°ì—´ ì´ˆê¸°í™”
        }

        // ì§€ë„ì˜ ì´ë™ì´ ëë‚  ë•Œë§ˆë‹¤ ë§ˆì»¤ë¥¼ ì—…ë°ì´íŠ¸
        kakao.maps.event.addListener(map, 'idle', function() {
            console.log('idle ì´ë²¤íŠ¸ ë°œìƒ');
            var bounds = map.getBounds();
            var southWest = bounds.getSouthWest();
            var northEast = bounds.getNorthEast();
            if (currentOverlay) {
                currentOverlay.setMap(null);
                currentOverlay = null;
            }

            // Ajax ìš”ì²­ì„ ë³´ë‚´ëŠ” ë¶€ë¶„
            $.ajax({
                url: '/filterEvents',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    markersInfo: markersInfo,
                    bounds: {
                        southWestLat: bounds.getSouthWest().getLat(),
                        southWestLng: bounds.getSouthWest().getLng(),
                        northEastLat: bounds.getNorthEast().getLat(),
                        northEastLng: bounds.getNorthEast().getLng()
                    }
                }),
                success: function(filteredEvents) {
                    console.log("success")

                    // í•„í„°ë§ëœ í–‰ì‚¬ ë°ì´í„°ë¡œ í˜ì´ì§€ì˜ ë‚´ìš©ì„ ì—…ë°ì´íŠ¸
                    updatePageWithFilteredEvents(filteredEvents);
                },
                error: function(error) {
                    console.error('Error fetching filtered events:', error);
                }
            });

        });

        // ì§€ë„ì— idle ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
        kakao.maps.event.addListener(map, 'idle', searchPlaces);
        contentNode.className = 'placeinfo_wrap';

        // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ì˜ ì»¨í…ì¸  ë…¸ë“œì— mousedown, touchstart ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ë•Œ
        // ì§€ë„ ê°ì²´ì— ì´ë²¤íŠ¸ê°€ ì „ë‹¬ë˜ì§€ ì•Šë„ë¡ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¡œ kakao.maps.event.preventMap ë©”ì†Œë“œë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
        addEventHandle(contentNode, 'mousedown', kakao.maps.event.preventMap);
        addEventHandle(contentNode, 'touchstart', kakao.maps.event.preventMap);
        // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ ì»¨í…ì¸ ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
        placeOverlay.setContent(contentNode);

        // ê° ì¹´í…Œê³ ë¦¬ì— í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
        addCategoryClickEvent();
        // ì—˜ë¦¬ë¨¼íŠ¸ì— ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ë“±ë¡í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
        function addEventHandle(target, type, callback) {
            if (target.addEventListener) {
                target.addEventListener(type, callback);
            } else {
                target.attachEvent('on' + type, callback);
            }
        }

        // ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ì„ ìš”ì²­í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
        function searchPlaces() {
            if (!currCategory) {
                return;
            }

            // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤
            placeOverlay.setMap(null);

            // ì§€ë„ì— í‘œì‹œë˜ê³  ìˆëŠ” ë§ˆì»¤ë¥¼ ì œê±°í•©ë‹ˆë‹¤
            removeCategoryMarker();

            ps.categorySearch(currCategory, placesSearchCB, {useMapBounds:true});
        }

        // ì¥ì†Œê²€ìƒ‰ì´ ì™„ë£Œëì„ ë•Œ í˜¸ì¶œë˜ëŠ” ì½œë°±í•¨ìˆ˜ ì…ë‹ˆë‹¤
        function placesSearchCB(data, status, pagination) {
            if (status === kakao.maps.services.Status.OK) {

                // ì •ìƒì ìœ¼ë¡œ ê²€ìƒ‰ì´ ì™„ë£Œëìœ¼ë©´ ì§€ë„ì— ë§ˆì»¤ë¥¼ í‘œì¶œí•©ë‹ˆë‹¤
                displayPlaces(data);
            } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
                // ê²€ìƒ‰ê²°ê³¼ê°€ ì—†ëŠ”ê²½ìš° í•´ì•¼í•  ì²˜ë¦¬ê°€ ìˆë‹¤ë©´ ì´ê³³ì— ì‘ì„±í•´ ì£¼ì„¸ìš”

            } else if (status === kakao.maps.services.Status.ERROR) {
                // ì—ëŸ¬ë¡œ ì¸í•´ ê²€ìƒ‰ê²°ê³¼ê°€ ë‚˜ì˜¤ì§€ ì•Šì€ ê²½ìš° í•´ì•¼í•  ì²˜ë¦¬ê°€ ìˆë‹¤ë©´ ì´ê³³ì— ì‘ì„±í•´ ì£¼ì„¸ìš”

            }
        }

        // ì§€ë„ì— ë§ˆì»¤ë¥¼ í‘œì¶œí•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
        function displayPlaces(places) {
            for ( var i=0; i<places.length; i++ ) {

                // ë§ˆì»¤ë¥¼ ìƒì„±í•˜ê³  ì§€ë„ì— í‘œì‹œí•©ë‹ˆë‹¤
                var marker = addCategoryMarker(new kakao.maps.LatLng(places[i].y, places[i].x));
                var currentMarker = null; // í˜„ì¬ í´ë¦­ëœ ë§ˆì»¤ë¥¼ ì €ì¥í•  ë³€ìˆ˜
                var isOverlayShown = false; // ì˜¤ë²„ë ˆì´ í‘œì‹œ ìƒíƒœ

                // ë§ˆì»¤ì™€ ê²€ìƒ‰ê²°ê³¼ í•­ëª©ì„ í´ë¦­ í–ˆì„ ë•Œ
                // ì¥ì†Œì •ë³´ë¥¼ í‘œì¶œí•˜ë„ë¡ í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
                (function(marker, place) {
                    kakao.maps.event.addListener(marker, 'click', function() {
                        if (currentMarker === marker && isOverlayShown) {
                            placeOverlay.setMap(null); // ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
                            isOverlayShown = false; // ì˜¤ë²„ë ˆì´ í‘œì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
                            currentMarker = null; // í˜„ì¬ ë§ˆì»¤ ì°¸ì¡° ì œê±°
                        } else {
                            // í˜„ì¬ í´ë¦­ëœ ë§ˆì»¤ê°€ ì´ì „ì— í´ë¦­ëœ ë§ˆì»¤ì™€ ë‹¤ë¥´ë‹¤ë©´,
                            // ìƒˆë¡œìš´ ìƒì„¸ ì •ë³´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
                            displayPlaceInfo(place);
                            currentMarker = marker; // í˜„ì¬ í´ë¦­ëœ ë§ˆì»¤ë¥¼ ì €ì¥
                            isOverlayShown = true; // ì˜¤ë²„ë ˆì´ í‘œì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
                        }
                    });
                })(marker, places[i]);
            }
        }

        // ë§ˆì»¤ë¥¼ ìƒì„±í•˜ê³  ì§€ë„ ìœ„ì— ë§ˆì»¤ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
        function addCategoryMarker(position) {
            var imageSrc;
            if (currCategory === 'SW8') { // ì§€í•˜ì²  ì—­
                imageSrc = "image/128654.png"; // ì§€í•˜ì²  ì—­ì— ëŒ€í•œ ë§ˆì»¤ ì´ë¯¸ì§€ URL
            } else if (currCategory === 'PK6') { // ì£¼ì°¨ì¥
                imageSrc = "image/128655.png"; // ì£¼ì°¨ì¥ì— ëŒ€í•œ ë§ˆì»¤ ì´ë¯¸ì§€ URL
            }
            else {
                // ê¸°ë³¸ ì´ë¯¸ì§€ URL
                imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/places_category.png';
            }
            var imageSize = new kakao.maps.Size(30, 32),
                markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize),
                marker = new kakao.maps.Marker({
                    position: position, // ë§ˆì»¤ì˜ ìœ„ì¹˜
                    image: markerImage
                });

            marker.setMap(map); // ì§€ë„ ìœ„ì— ë§ˆì»¤ë¥¼ í‘œì¶œí•©ë‹ˆë‹¤
            categorymarkers.push(marker);  // ë°°ì—´ì— ìƒì„±ëœ ë§ˆì»¤ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤

            return marker;
        }

        // ì§€ë„ ìœ„ì— í‘œì‹œë˜ê³  ìˆëŠ” ë§ˆì»¤ë¥¼ ëª¨ë‘ ì œê±°í•©ë‹ˆë‹¤
        function removeCategoryMarker() {
            for ( var i = 0; i < categorymarkers.length; i++ ) {
                categorymarkers[i].setMap(null);
            }
            categorymarkers = [];
        }

        // í´ë¦­í•œ ë§ˆì»¤ì— ëŒ€í•œ ì¥ì†Œ ìƒì„¸ì •ë³´ë¥¼ ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ë¡œ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
        function displayPlaceInfo (place) {
            var content = '<div class="placeinfo">' +
                '   <a class="title" href="' + place.place_url + '" target="_blank" title="' + place.place_name + '">' + place.place_name + '</a>';

            if (place.road_address_name) {
                content += '    <span title="' + place.road_address_name + '">' + place.road_address_name + '</span>' +
                    '  <span class="jibun" title="' + place.address_name + '">(ì§€ë²ˆ : ' + place.address_name + ')</span>';
            }  else {
                content += '    <span title="' + place.address_name + '">' + place.address_name + '</span>';
            }

            content += '    <span class="tel">' + place.phone + '</span>' +
                '</div>' +
                '<div class="after"></div>';

            contentNode.innerHTML = content;
            placeOverlay = new kakao.maps.CustomOverlay({
                content: contentNode,
                map: map,
                position: new kakao.maps.LatLng(place.y, place.x),
                yAnchor: 1.35 // ì´ ê°’ì„ ì¡°ì ˆí•˜ì—¬ ì˜¤ë²„ë ˆì´ì˜ ìœ„ì¹˜ë¥¼ ë§ˆì»¤ ìœ„ìª½ìœ¼ë¡œ ì¡°ì •
            });
        }


        // ê° ì¹´í…Œê³ ë¦¬ì— í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
        function addCategoryClickEvent() {
            var category = document.getElementById('category'),
                children = category.children;

            for (var i=0; i<children.length; i++) {
                children[i].onclick = onClickCategory;
            }
        }

        // ì¹´í…Œê³ ë¦¬ë¥¼ í´ë¦­í–ˆì„ ë•Œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
        function onClickCategory() {
            var id = this.id,
                className = this.className;

            placeOverlay.setMap(null);

            if (className === 'on') {
                currCategory = '';
                changeCategoryClass();
                removeCategoryMarker();
            } else {
                currCategory = id;
                changeCategoryClass(this);
                searchPlaces();
            }
        }

        // í´ë¦­ëœ ì¹´í…Œê³ ë¦¬ì—ë§Œ í´ë¦­ëœ ìŠ¤íƒ€ì¼ì„ ì ìš©í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤
        function changeCategoryClass(el) {
            var category = document.getElementById('category'),
                children = category.children,
                i;

            for ( i=0; i<children.length; i++ ) {
                children[i].className = '';
            }

            if (el) {
                el.className = 'on';
            }
        }

        function updatePageWithFilteredEvents(events) {
            // í–‰ì‚¬ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ì›¹ í˜ì´ì§€ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ì½”ë“œë¥¼ ì—¬ê¸°ì— ì‘ì„±í•©ë‹ˆë‹¤.
            // ì˜ˆë¥¼ ë“¤ì–´, Thymeleaf ëŒ€ì‹  ìˆœìˆ˜ JavaScriptë¡œ DOMì„ ì¡°ì‘í•˜ì—¬
            // í–‰ì‚¬ ëª©ë¡ì„ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

            // ì›¹ í˜ì´ì§€ì— í–‰ì‚¬ë¥¼ í‘œì‹œí•˜ëŠ” ë¡œì§ì„ ì‘ì„±í•©ë‹ˆë‹¤.
            const eventsContainer = document.getElementById('eventsContainer');
            eventsContainer.innerHTML = ''; // ê¸°ì¡´ì˜ í–‰ì‚¬ ëª©ë¡ì„ ë¹„ì›ë‹ˆë‹¤.


            // ë°›ì€ í–‰ì‚¬ ë°ì´í„°ë¥¼ ì´ìš©í•˜ì—¬ ìƒˆë¡œìš´ ëª©ë¡ ì•„ì´í…œì„ ìƒì„±í•©ë‹ˆë‹¤.
            events.forEach(event => {

                var item = document.createElement('div');
                item.classList.add('item');
                item.style.marginBottom='20px';
                item.style.marginLeft='8px';

                var imageLink = document.createElement('a');
                imageLink.href = `/eventInfo?title=${encodeURIComponent(event.title)}`;

                var image = document.createElement('img');
                image.src = event.main_IMG;
                image.alt = 'Event Image';
                image.style.borderRadius='5px';
                image.style.boxShadow='2px 2px gray';
                image.style.borderRadius='5px';

                var title = document.createElement('h4');
                title.innerText = event.title;
                title.style.marginTop='0px';
                title.style.marginBottom='12px';
                title.style.marginLeft='8px';
                title.style.overflow='hidden';
                title.style.textOverflow='ellipsis';
                title.style.whiteSpace='nowrap';
                title.style.maxWidth='260px';
                title.style.fontSize='17px';

                var isFree = document.createElement('p');
                isFree.innerText = event.is_FREE;
                isFree.classList.add('is-free');
                isFree.style.marginLeft = '8px';
                isFree.style.marginBottom = '5px';
                isFree.style.fontSize='15px';

                var imageContainer = document.createElement('div');
                imageLink.appendChild(image);
                imageContainer.appendChild(imageLink);
                imageContainer.style.width='100px';
                imageContainer.style.height='140px';

                var eventdate = document.createElement('p');
                eventdate.innerText = event.date;
                eventdate.style.marginLeft = '8px';
                eventdate.style.marginBottom = '5px';
                eventdate.style.fontSize='15px';

                var place = document.createElement('p');
                place.innerText = event.place;
                place.style.marginLeft= '8px';
                place.style.overflow='hidden';
                place.style.textOverflow='ellipsis';
                place.style.whiteSpace='nowrap';
                place.style.maxWidth='260px';
                place.style.marginBottom = '5px';
                place.style.fontSize='15px';

                var titleContainer = document.createElement('div');
                titleContainer.appendChild(title);
                titleContainer.appendChild(isFree);
                titleContainer.appendChild(eventdate);
                titleContainer.appendChild(place);

                var locationButton = document.createElement('button');
                locationButton.className = 'event-location';
                locationButton.type = 'button';
                locationButton.onclick = function() {
                    moveToLocation(event.lat, event.lot);
                };
                var locationImage = document.createElement('img');
                locationImage.src = "/image/13807908.png";
                locationImage.alt = "ìœ„ì¹˜ë¡œë”©";
                locationImage.style.width = "25px"; // ì´ë¯¸ì§€ ë„ˆë¹„ ì„¤ì •
                locationImage.style.height = "25px"; // ì´ë¯¸ì§€ ë†’ì´ ì„¤ì •
                locationButton.appendChild(locationImage);
                locationButton.style.position = 'absolute';
                locationButton.style.right = '15px';
                locationButton.style.bottom = '50px';
                locationButton.style.width = '25px';
                locationButton.style.height = '25px';
                locationButton.style.background = 'transparent';
                locationButton.style.border = 'none';
                locationButton.style.cursor = 'pointer';


                // eventsContainerì— ìƒˆë¡œìš´ í–‰ì‚¬ ì•„ì´í…œì„ ì¶”ê°€í•©ë‹ˆë‹¤.
                item.appendChild(imageContainer);
                item.appendChild(titleContainer);
                item.appendChild(locationButton);
                eventsContainer.appendChild(item);
            });

            // ì´ë²¤íŠ¸ê°€ ì—†ì„ ë•Œ í‘œì‹œí•  ë©”ì‹œì§€ì…ë‹ˆë‹¤.
            if (events.length === 0) {
                var noEventsMsg = document.createElement('p');
                noEventsMsg.innerText = 'ì§„í–‰ì¤‘ì¸ í–‰ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.';
                document.getElementById('eventsContainer').appendChild(noEventsMsg);
            }

        }
        function moveToLocation(lat, lng) {
            var moveLatLon = new kakao.maps.LatLng(lng, lat);
            map.panTo(moveLatLon);

            // ì§€ë„ ë ˆë²¨ ì¡°ì •ì„ ìœ„í•œ í•¨ìˆ˜
            function adjustLevel() {
                var currentLevel = map.getLevel();
                if (currentLevel > 3) {
                    map.setLevel(currentLevel - 2, {animate: {duration: 500}});
                    setTimeout(adjustLevel, 550);
                }
            }

            // ìµœì´ˆì˜ ë ˆë²¨ ì¡°ì • ì‹¤í–‰
            setTimeout(adjustLevel, 550);
            map.panTo(moveLatLon);
        }
        var currentLocationMarker = null; // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
        document.getElementById('CurrentLocation').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    var lat = position.coords.latitude; // ìœ„ë„
                    var lng = position.coords.longitude; // ê²½ë„
                    var moveLatLon = new kakao.maps.LatLng(lat, lng);

                    if (currentLocationMarker) {
                        currentLocationMarker.setMap(null);
                    }

                    var imageSrc = "image/currentlocation.png";
                    var imageSize = new kakao.maps.Size(35, 35);
                    var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);
                    currentLocationMarker = new kakao.maps.Marker({
                        position: moveLatLon, // ë§ˆì»¤ì˜ ìœ„ì¹˜
                        image: markerImage
                    });

                    // ì§€ë„ì˜ ì¤‘ì‹¬ì„ ì‚¬ìš©ìì˜ í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™
                    map.panTo(moveLatLon);
                    currentLocationMarker.setMap(map);
                    // ì§€ë„ë¥¼ í™•ëŒ€
                    map.setLevel(4, {animate: true});
                }, function(error) {
                    console.error("Geolocation error: " + error.message);
                }, {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 5000
                });
            } else {
                alert('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” í˜„ì¬ìœ„ì¹˜ê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        });
    </script>

</div>


</body>
</html>