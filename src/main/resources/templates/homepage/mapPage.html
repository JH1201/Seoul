<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>서울은 지금</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="/mapPageCss/MapPageCss.css">
</head>
<body>


<div id="container">
    <div id="details">
        <h1>
            <a href="/home" style="text-decoration: none">서울은 지금</a>
        </h1>

        <div class="search-container">
            <div class="searchUpPart">
                <div class="dateSearch">
                    <div class="date">
                        <label for="date1">
                            <input type="date" id="date1"></input>
                        </label>
                    </div>
                    <div class="date" style="display: flex; align-items: center; height: 60px;"> ~ </div>
                    <div class="date">
                        <label for="date2">
                            <input type="date" id="date2" value="2024-12-31"></input>
                        </label>
                    </div>
                </div>

                <div>
                    <form class="search-part" id="searchForm" action="/search" method="get">
                        <input type="text" name="keyword" class="search-bar" placeholder="키워드를 입력하세요.&#10;(ex: 행사명, 장소, 역 등)" >
                        <button class="search-button" type="submit">🔍︎</button>
                    </form>
                </div>
            </div>
            <br><br>
            <div class="searchDownPart">
                <div class="eventType">
                    <input type="checkbox" id="select0" name="codename" value="전체"><label for="select0" id="select0Label"> 전체</label>
                    <input type="checkbox" id="select1" name="codename" value="뮤지컬/오페라"><label for="select1" id="select1Label"> 뮤지컬/오페라</label>
                    <input type="checkbox" id="select2" name="codename" value="연극"><label for="select2" id="select2Label"> 연극</label>
                    <input type="checkbox" id="select3" name="codename" value="무용"><label for="select3" id="select3Label"> 무용</label>
                    <input type="checkbox" id="select4" name="codename" value="국악"><label for="select4" id="select4Label"> 국악</label>
                    <input type="checkbox" id="select5" name="codename" value="클래식"><label for="select5" id="select5Label"> 클래식</label>
                    <input type="checkbox" id="select6" name="codename" value="전시/미술"><label for="select6" id="select6Label"> 전시/미술</label>
                    <input type="checkbox" id="select7" name="codename" value="교육/체험"><label for="select7" id="select7Label"> 교육/체험</label>
                    <input type="checkbox" id="select8" name="codename" value="콘서트"><label for="select8" id="select8Label"> 콘서트</label>
                    <input type="checkbox" id="select9" name="codename" value="영화"><label for="select9" id="select9Label"> 영화</label>
                    <input type="checkbox" id="select10" name="codename" value="독주/독창회"><label for="select10" id="select10Label"> 독주/독창회</label>
                    <input type="checkbox" id="select11" name="codename" value="축제"><label for="select11" id="select11Label"> 축제</label>
                    <input type="checkbox" id="select12" name="codename" value="기타"><label for="select12" id="select12Label"> 기타</label>
                </div><br><br>

                <div class="locationName">
                    <input type="checkbox" id="location0" name="codename" value="전체"><label for="location0" id="location0Label"> 전체</label>
                    <input type="checkbox" id="location1" name="codename" value="강남구"><label for="location1" id="location1Label"> 강남구</label>
                    <input type="checkbox" id="location2" name="codename" value="강동구"><label for="location2" id="location2Label"> 강동구</label>
                    <input type="checkbox" id="location3" name="codename" value="강북구"><label for="location3" id="location3Label"> 강북구</label>
                    <input type="checkbox" id="location4" name="codename" value="강서구"><label for="location4" id="location4Label"> 강서구</label>
                    <input type="checkbox" id="location5" name="codename" value="관악구"><label for="location5" id="location5Label"> 관악구</label>
                    <input type="checkbox" id="location6" name="codename" value="광진구"><label for="location6" id="location6Label"> 광진구</label>
                    <input type="checkbox" id="location7" name="codename" value="구로구"><label for="location7" id="location7Label"> 구로구</label>
                    <input type="checkbox" id="location8" name="codename" value="금천구"><label for="location8" id="location8Label"> 금천구</label>
                    <input type="checkbox" id="location9" name="codename" value="노원구"><label for="location9" id="location9Label"> 노원구</label>
                    <input type="checkbox" id="location10" name="codename" value="도봉구"><label for="location10" id="location10Label"> 도봉구</label>
                    <input type="checkbox" id="location11" name="codename" value="동대문구"><label for="location11" id="location11Label"> 동대문구</label>
                    <input type="checkbox" id="location12" name="codename" value="동작구"><label for="location12" id="location12Label"> 동작구</label>
                    <input type="checkbox" id="location13" name="codename" value="마포구"><label for="location13" id="location13Label"> 마포구</label>
                    <input type="checkbox" id="location14" name="codename" value="서대문구"><label for="location14" id="location14Label"> 서대문구</label>
                    <input type="checkbox" id="location15" name="codename" value="서초구"><label for="location15" id="location15Label"> 서초구</label>
                    <input type="checkbox" id="location16" name="codename" value="성동구"><label for="location16" id="location16Label"> 성동구</label>
                    <input type="checkbox" id="location17" name="codename" value="성북구"><label for="location17" id="location17Label"> 성북구</label>
                    <input type="checkbox" id="location18" name="codename" value="송파구"><label for="location18" id="location18Label"> 송파구</label>
                    <input type="checkbox" id="location19" name="codename" value="양천구"><label for="location19" id="location19Label"> 양천구</label>
                    <input type="checkbox" id="location20" name="codename" value="영등포구"><label for="location20" id="location20Label"> 영등포구</label>
                    <input type="checkbox" id="location21" name="codename" value="용산구"><label for="location21" id="location21Label"> 용산구</label>
                    <input type="checkbox" id="location22" name="codename" value="은평구"><label for="location22" id="location22Label"> 은평구</label>
                    <input type="checkbox" id="location23" name="codename" value="종로구"><label for="location23" id="location23Label"> 종로구</label>
                    <input type="checkbox" id="location24" name="codename" value="중구"><label for="location24" id="location24Label"> 중구</label>
                    <input type="checkbox" id="location25" name="codename" value="중랑구"><label for="location25" id="location25Label"> 중랑구</label>

                    <!--<select id="location" onchange="sort()">
                        <option value="종로구" th:selected="${selectedMonth == '종로구'}">종로구</option>
                        <option value="즐겨찾기" th:selected="${selectedMonth == '즐겨찾기'}">즐겨찾기</option>
                        <option value="강남구" th:selected="${selectedMonth == '강남구'}">강남구</option>
                        <option value="강서구" th:selected="${selectedMonth == '강서구'}">강서구</option>
                        <option value="중구" th:selected="${selectedMonth == '중구'}">중구</option>
                        <option value="마포구" th:selected="${selectedMonth == '마포구'}">마포구</option>
                        <option value="은평구" th:selected="${selectedMonth == '은평구'}">은평구</option>

                    </select>-->

                    <script>
                        function sort() {
                            var selectedOption = document.getElementById('sortOptions').value;
                            // 서버로 GET 요청 보내기
                            fetch(`/get함수이름?지역=${location}`)
                                .then(response => response.text())
                                .then(html => {
                                    // 페이지의 일부를 서버의 응답으로 업데이트
                                    document.getElementById('content').innerHTML = html;
                                })
                                .catch(error => console.error('Error:', error));
                        }
                    </script>
                </div><br><br>
                <div class="detailButton">
                    <button id="detailSearch"> 검색하기 </button>
                    <button id="resetButton"> 선택 초기화 </button>
                </div>
            </div>
            <script>
                // 현재 날짜를 가져오는 함수
                function getCurrentDate() {
                    const today = new Date();
                    const year = today.getFullYear();
                    let month = today.getMonth() + 1;
                    let day = today.getDate();

                    // 월과 일이 한 자리 숫자인 경우 앞에 0을 추가해줍니다.
                    if (month < 10) {
                        month = '0' + month;
                    }
                    if (day < 10) {
                        day = '0' + day;
                    }

                    return `${year}-${month}-${day}`;
                }

                // input 요소의 value 속성에 현재 날짜를 설정합니다.
                document.getElementById('date1').value = getCurrentDate();
            </script>

        </div>

        <h3>지도에 있는 행사들의 리스트</h3>
        <div id="eventsContainer">
        <div class="items-grid">
            <div th:each="event : ${lists}" class="item">
                <a th:href="@{/eventInfo(title=${event.getTITLE()})}">
                    <img th:src="${event.getMAIN_IMG()}" alt="Event Image">
                </a>
                <div>
                    <h4 th:text="${event.getTITLE()}"></h4>
                    <p class="is-free" th:text="${event.getIS_FREE()}"></p>
                </div>
                <button class="event-location" type="submit" th:data-lat="${event.getLAT()}" th:data-lng="${event.getLOT()}">
                    <img src="/image/13807908.png" alt="위치로딩">
                </button>
            </div>

            <div th:if="${lists == null || lists.isEmpty()}">
            <p>검색 결과가 없습니다.</p>
            </div>
        </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // eventType과 locationName 섹션의 모든 체크박스 처리
                document.querySelectorAll('.eventType input[type="checkbox"], .locationName input[type="checkbox"]').forEach(function(checkbox) {
                    checkbox.addEventListener('change', function() {
                        const parentDiv = this.closest('div'); // 현재 체크박스의 부모 div
                        const allCheckbox = parentDiv.querySelector('input[type="checkbox"][value="전체"]'); // 현재 섹션의 '전체' 체크박스

                        if (this.value === "전체") {
                            // '전체' 체크박스가 선택된 경우, 다른 모든 체크박스 해제
                            if (this.checked) {
                                parentDiv.querySelectorAll('input[type="checkbox"]:not([value="전체"])').forEach(cb => cb.checked = false);
                            }
                        } else {
                            // '전체'가 아닌 체크박스 선택 시 '전체' 체크박스 해제
                            allCheckbox.checked = false;

                            // 다른 체크박스가 하나라도 선택된 경우 '전체' 체크박스 유지를 해제
                            const anyChecked = Array.from(parentDiv.querySelectorAll('input[type="checkbox"]:not([value="전체"])')).some(cb => cb.checked);
                            if (!anyChecked) {
                                // 모든 체크박스가 해제되면 '전체' 체크박스를 자동으로 선택하지 않음
                                allCheckbox.checked = false;
                            }
                        }
                    });
                });

                // '선택 초기화' 버튼 클릭 이벤트
                document.getElementById('resetButton').addEventListener('click', function() {
                    document.querySelectorAll('.searchDownPart input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
                });

                document.getElementById('detailSearch').addEventListener('click', function(event) {
                    event.preventDefault();
                    var eventTypes = Array.from(document.querySelectorAll('.eventType input[type="checkbox"]:checked')).map(checkbox => checkbox.value).join(",");
                    var locations = Array.from(document.querySelectorAll('.locationName input[type="checkbox"]:checked')).map(checkbox => checkbox.value).join(",");
                    var keyword = document.querySelector('.search-bar').value.trim(); // 키워드 검색어
                    var startDate = document.getElementById('date1').value; // 시작 날짜
                    var endDate = document.getElementById('date2').value; // 종료 날짜

                    fetch(`/mapsearchEvents?keyword=${encodeURIComponent(keyword)}&startDate=${startDate}&endDate=${endDate}&eventTypes=${eventTypes}&locations=${locations}`, {
                        headers: {
                            'Accept': 'application/json'
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            updatePageWithFilteredEvents(data); // 검색 결과로 UI 업데이트하는 함수
                            addMarkersToMap2(map, data);
                        })
                        .catch(error => console.error('Error:', error));
                });
                document.getElementById('searchForm').addEventListener('click', function(event) {
                    event.preventDefault();
                    var eventTypes = Array.from(document.querySelectorAll('.eventType input[type="checkbox"]:checked')).map(checkbox => checkbox.value).join(",");
                    var locations = Array.from(document.querySelectorAll('.locationName input[type="checkbox"]:checked')).map(checkbox => checkbox.value).join(",");
                    var keyword = document.querySelector('.search-bar').value.trim(); // 키워드 검색어
                    var startDate = document.getElementById('date1').value; // 시작 날짜
                    var endDate = document.getElementById('date2').value; // 종료 날짜

                    fetch(`/mapsearchEvents?keyword=${encodeURIComponent(keyword)}&startDate=${startDate}&endDate=${endDate}&eventTypes=${eventTypes}&locations=${locations}`, {
                        headers: {
                            'Accept': 'application/json'
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            updatePageWithFilteredEvents(data); // 검색 결과로 UI 업데이트하는 함수
                            addMarkersToMap2(map, data);
                        })
                        .catch(error => console.error('Error:', error));
                });

                document.querySelectorAll('.event-location').forEach(function(button) {
                    button.addEventListener('click', function() {
                        const lat = this.getAttribute('data-lat');
                        const lng = this.getAttribute('data-lng');
                        moveToLocation(lat, lng);
                    });
                });
            });
        </script>

    </div>
    <div class="map_wrap">
    <div id="map"></div>
    <div class="custom_typecontrol radius_border">
        <span id="btnRoadmap" class="selected_btn" onclick="setMapType('roadmap')">지도</span>
        <span id="btnSkyview" class="btn" onclick="setMapType('skyview')">스카이뷰</span>
    </div>
    <!-- 지도 확대, 축소 컨트롤 div 입니다 -->
    <div class="custom_zoomcontrol radius_border">
        <span onclick="zoomIn()"><img src="https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/ico_plus.png" alt="확대"></span>
        <span onclick="zoomOut()"><img src="https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/ico_minus.png" alt="축소"></span>
    </div>
        <ul id="category">
            <li id="SW8">
                <img src="image/128654.png">
                지하철역
            </li>
            <li id="PK6">
                <img src="image/128655.png">
                주차장
            </li>
        </ul>
    </div>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=33db73c119b1dea112b5e9038fd6ef2a&libraries=services"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script th:inline="javascript">
        // 마커를 클릭했을 때 해당 장소의 상세정보를 보여줄 커스텀오버레이입니다
        var placeOverlay = new kakao.maps.CustomOverlay({zIndex:1}),
            contentNode = document.createElement('div'), // 커스텀 오버레이의 컨텐츠 엘리먼트 입니다
            categorymarkers = [], // 마커를 담을 배열입니다
            currCategory = ''; // 현재 선택된 카테고리를 가지고 있을 변수입니다
        // 카카오맵 API 초기화
        var mapContainer = document.getElementById('map'), // 지도를 표시할 div
            mapOption = {
                center: new kakao.maps.LatLng(37.566535, 126.9779692), // 지도의 중심좌표
                level: 7 // 지도의 확대 레벨
            };
        var map = new kakao.maps.Map(mapContainer, mapOption);
        var ps = new kakao.maps.services.Places(map);
        function setMapType(maptype) {
            var roadmapControl = document.getElementById('btnRoadmap');
            var skyviewControl = document.getElementById('btnSkyview');
            if (maptype === 'roadmap') {
                map.setMapTypeId(kakao.maps.MapTypeId.ROADMAP);
                roadmapControl.className = 'selected_btn';
                skyviewControl.className = 'btn';
            } else {
                map.setMapTypeId(kakao.maps.MapTypeId.HYBRID);
                skyviewControl.className = 'selected_btn';
                roadmapControl.className = 'btn';
            }
        }
        function zoomIn() {
            map.setLevel(map.getLevel() - 1, {animate: true});
        }

        function zoomOut() {
            map.setLevel(map.getLevel() + 1, {animate: true});
        }

        var  cultureInfoList = [[${lists}]]; // 행사 정보 리스트
        var markersInfo = [];
        var markers = [];
        var currentMarker = null;
        var currentOverlay = null;
        addMarkersToMap(map, cultureInfoList);

        function addMarkersToMap(map, cultureInfoList) {
            removeMarkers();
            markersInfo = cultureInfoList;
            // 현재 지도의 경계를 가져옴
            var bounds = map.getBounds();
            var southWest = bounds.getSouthWest(); // 남서쪽 좌표
            var northEast = bounds.getNorthEast(); // 북동쪽 좌표

            console.log(southWest);
            console.log(northEast);


            cultureInfoList.forEach(function(cultureInfo) {
                var lat = parseFloat(cultureInfo.lat);
                var lng = parseFloat(cultureInfo.lot);

                var position = new kakao.maps.LatLng(lng, lat);

                var marker = new kakao.maps.Marker({
                    map: map,
                    position: position
                });
                // 새로운 마커를 배열에 추가
                markers.push(marker);

                kakao.maps.event.addListener(marker, 'click', function() {

                    var matchingEvents = cultureInfoList.filter(function(event) {
                        return parseFloat(event.lat) === lat && parseFloat(event.lot) === lng;
                    });
                    // 현재 마커가 이전에 클릭된 마커와 동일하면 커스텀 오버레이를 숨깁니다.
                    if (currentMarker === marker && currentOverlay) {
                        currentOverlay.setMap(null);
                        currentMarker = null;
                        currentOverlay = null;
                    } else {
                        // 다른 마커를 클릭했을 때, 이전 오버레이를 숨기고 새로운 정보를 표시합니다.
                        if (currentOverlay) {
                            currentOverlay.setMap(null);
                            currentOverlay = null;
                        }

                        if (matchingEvents.length > 0) {
                            var containerHTML = '<div class="markerinfo-container" style="position: relative; bottom: 35px; margin-bottom: 8px;">';
                            var eventsHTML = matchingEvents.map(function(event) {
                                var eventInfoUrl = `/eventInfo?title=${encodeURIComponent(event.title)}`;
                                return `<div class="markerinfo">
                            <a class="title" href="${eventInfoUrl}" target="_blank">${event.title}</a>
                            <span>${event.place}</span>
                        </div>`;
                            }).join('');
                            containerHTML += eventsHTML + '</div>';

                            var overlay = new kakao.maps.CustomOverlay({
                                content: containerHTML,
                                map: map,
                                position: marker.getPosition(),
                                yAnchor: 1
                            });

                            currentOverlay = overlay;
                            currentMarker = marker;

                            setTimeout(() => {
                                document.querySelector('.markerinfo-container').addEventListener('wheel', function(event) {
                                    event.preventDefault();
                                    event.stopPropagation();
                                    this.scrollTop += event.deltaY * 2;
                                }, { passive: false });
                            }, 0);
                        }
                    }
                });

            });
        }

        function addMarkersToMap2(map, cultureInfoList) {
            removeMarkers(); // 기존 마커 삭제
            markersInfo = cultureInfoList;

            // cultureInfoList가 비어있는지 확인
            if (!cultureInfoList || cultureInfoList.length === 0) {
                // 지도의 중심좌표와 확대 레벨 설정
                map.setCenter(new kakao.maps.LatLng(37.566535, 126.9779692));
                map.setLevel(7);
                return; // 함수 종료
            }

            // 현재 지도의 경계를 가져옴
            var bounds = new kakao.maps.LatLngBounds();

            cultureInfoList.forEach(function(cultureInfo) {
                var lat = parseFloat(cultureInfo.lat);
                var lng = parseFloat(cultureInfo.lot);

                var position = new kakao.maps.LatLng(lng, lat);
                bounds.extend(position);

                var marker = new kakao.maps.Marker({
                    map: map,
                    position: position
                });
                // 새로운 마커를 배열에 추가
                markers.push(marker);
                kakao.maps.event.addListener(marker, 'click', function() {

                    var matchingEvents = cultureInfoList.filter(function(event) {
                        return parseFloat(event.lat) === lat && parseFloat(event.lot) === lng;
                    });
                    // 현재 마커가 이전에 클릭된 마커와 동일하면 커스텀 오버레이를 숨깁니다.
                    if (currentMarker === marker && currentOverlay) {
                        currentOverlay.setMap(null);
                        currentMarker = null;
                        currentOverlay = null;
                    } else {
                        // 다른 마커를 클릭했을 때, 이전 오버레이를 숨기고 새로운 정보를 표시합니다.
                        if (currentOverlay) {
                            currentOverlay.setMap(null);
                            currentOverlay = null;
                        }

                        if (matchingEvents.length > 0) {
                            var containerHTML = '<div class="markerinfo-container2" style="position: relative; bottom: 35px; margin-bottom: 8px;">';
                            var eventsHTML = matchingEvents.map(function(event) {
                                var eventInfoUrl = `/eventInfo?title=${encodeURIComponent(event.title)}`;
                                return `<div class="markerinfo2">
                            <a class="title" href="${eventInfoUrl}" target="_blank">${event.title}</a>
                            <span>${event.place}</span>
                        </div>`;
                            }).join('');
                            containerHTML += eventsHTML + '</div>';

                            var overlay = new kakao.maps.CustomOverlay({
                                content: containerHTML,
                                map: map,
                                position: marker.getPosition(),
                                yAnchor: 1
                            });

                            currentOverlay = overlay;
                            currentMarker = marker;

                            setTimeout(() => {
                                document.querySelector('.markerinfo-container2').addEventListener('wheel', function(event) {
                                    event.preventDefault();
                                    event.stopPropagation();
                                    this.scrollTop += event.deltaY * 2;
                                }, { passive: false });
                            }, 0);
                        }
                    }
                });

            });

            map.setBounds(bounds);
        }


        function removeMarkers() {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(null);
            }
            markers = []; // 마커 배열 초기화
        }

            // 지도의 이동이 끝날 때마다 마커를 업데이트
            kakao.maps.event.addListener(map, 'idle', function() {
                console.log('idle 이벤트 발생');
                var bounds = map.getBounds();
                var southWest = bounds.getSouthWest();
                var northEast = bounds.getNorthEast();
                if (currentOverlay) {
                    currentOverlay.setMap(null);
                    currentOverlay = null;
                }

                // Ajax 요청을 보내는 부분
                $.ajax({
                    url: '/filterEvents',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        markersInfo: markersInfo,
                        bounds: {
                            southWestLat: bounds.getSouthWest().getLat(),
                            southWestLng: bounds.getSouthWest().getLng(),
                            northEastLat: bounds.getNorthEast().getLat(),
                            northEastLng: bounds.getNorthEast().getLng()
                        }
                    }),
                    success: function(filteredEvents) {
                        console.log("success")

                        // 필터링된 행사 데이터로 페이지의 내용을 업데이트
                        updatePageWithFilteredEvents(filteredEvents);
                    },
                    error: function(error) {
                        console.error('Error fetching filtered events:', error);
                    }
                });

        });

        // 지도에 idle 이벤트를 등록합니다
        kakao.maps.event.addListener(map, 'idle', searchPlaces);
        contentNode.className = 'placeinfo_wrap';

        // 커스텀 오버레이의 컨텐츠 노드에 mousedown, touchstart 이벤트가 발생했을때
        // 지도 객체에 이벤트가 전달되지 않도록 이벤트 핸들러로 kakao.maps.event.preventMap 메소드를 등록합니다
        addEventHandle(contentNode, 'mousedown', kakao.maps.event.preventMap);
        addEventHandle(contentNode, 'touchstart', kakao.maps.event.preventMap);
        // 커스텀 오버레이 컨텐츠를 설정합니다
        placeOverlay.setContent(contentNode);

        // 각 카테고리에 클릭 이벤트를 등록합니다
        addCategoryClickEvent();
        // 엘리먼트에 이벤트 핸들러를 등록하는 함수입니다
        function addEventHandle(target, type, callback) {
            if (target.addEventListener) {
                target.addEventListener(type, callback);
            } else {
                target.attachEvent('on' + type, callback);
            }
        }

        // 카테고리 검색을 요청하는 함수입니다
        function searchPlaces() {
            if (!currCategory) {
                return;
            }

            // 커스텀 오버레이를 숨깁니다
            placeOverlay.setMap(null);

            // 지도에 표시되고 있는 마커를 제거합니다
            removeCategoryMarker();

            ps.categorySearch(currCategory, placesSearchCB, {useMapBounds:true});
        }

        // 장소검색이 완료됐을 때 호출되는 콜백함수 입니다
        function placesSearchCB(data, status, pagination) {
            if (status === kakao.maps.services.Status.OK) {

                // 정상적으로 검색이 완료됐으면 지도에 마커를 표출합니다
                displayPlaces(data);
            } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
                // 검색결과가 없는경우 해야할 처리가 있다면 이곳에 작성해 주세요

            } else if (status === kakao.maps.services.Status.ERROR) {
                // 에러로 인해 검색결과가 나오지 않은 경우 해야할 처리가 있다면 이곳에 작성해 주세요

            }
        }

        // 지도에 마커를 표출하는 함수입니다
        function displayPlaces(places) {
            for ( var i=0; i<places.length; i++ ) {

                // 마커를 생성하고 지도에 표시합니다
                var marker = addCategoryMarker(new kakao.maps.LatLng(places[i].y, places[i].x));
                var currentMarker = null; // 현재 클릭된 마커를 저장할 변수
                var isOverlayShown = false; // 오버레이 표시 상태

                // 마커와 검색결과 항목을 클릭 했을 때
                // 장소정보를 표출하도록 클릭 이벤트를 등록합니다
                (function(marker, place) {
                    kakao.maps.event.addListener(marker, 'click', function() {
                        if (currentMarker === marker && isOverlayShown) {
                            placeOverlay.setMap(null); // 오버레이 숨기기
                            isOverlayShown = false; // 오버레이 표시 상태 업데이트
                            currentMarker = null; // 현재 마커 참조 제거
                        } else {
                            // 현재 클릭된 마커가 이전에 클릭된 마커와 다르다면,
                            // 새로운 상세 정보를 표시합니다.
                            displayPlaceInfo(place);
                            currentMarker = marker; // 현재 클릭된 마커를 저장
                            isOverlayShown = true; // 오버레이 표시 상태 업데이트
                        }
                    });
                })(marker, places[i]);
            }
        }

        // 마커를 생성하고 지도 위에 마커를 표시하는 함수입니다
        function addCategoryMarker(position) {
            var imageSrc;
            if (currCategory === 'SW8') { // 지하철 역
                imageSrc = "image/128654.png"; // 지하철 역에 대한 마커 이미지 URL
            } else if (currCategory === 'PK6') { // 주차장
                imageSrc = "image/128655.png"; // 주차장에 대한 마커 이미지 URL
            }
            else {
                // 기본 이미지 URL
                imageSrc = 'https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/places_category.png';
            }
            var imageSize = new kakao.maps.Size(30, 32),
                markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize),
                marker = new kakao.maps.Marker({
                    position: position, // 마커의 위치
                    image: markerImage
                });

            marker.setMap(map); // 지도 위에 마커를 표출합니다
            categorymarkers.push(marker);  // 배열에 생성된 마커를 추가합니다

            return marker;
        }

        // 지도 위에 표시되고 있는 마커를 모두 제거합니다
        function removeCategoryMarker() {
            for ( var i = 0; i < categorymarkers.length; i++ ) {
                categorymarkers[i].setMap(null);
            }
            categorymarkers = [];
        }

        // 클릭한 마커에 대한 장소 상세정보를 커스텀 오버레이로 표시하는 함수입니다
        function displayPlaceInfo (place) {
            var content = '<div class="placeinfo">' +
                '   <a class="title" href="' + place.place_url + '" target="_blank" title="' + place.place_name + '">' + place.place_name + '</a>';

            if (place.road_address_name) {
                content += '    <span title="' + place.road_address_name + '">' + place.road_address_name + '</span>' +
                    '  <span class="jibun" title="' + place.address_name + '">(지번 : ' + place.address_name + ')</span>';
            }  else {
                content += '    <span title="' + place.address_name + '">' + place.address_name + '</span>';
            }

            content += '    <span class="tel">' + place.phone + '</span>' +
                '</div>' +
                '<div class="after"></div>';

            contentNode.innerHTML = content;
            placeOverlay = new kakao.maps.CustomOverlay({
                content: contentNode,
                map: map,
                position: new kakao.maps.LatLng(place.y, place.x),
                yAnchor: 1.35 // 이 값을 조절하여 오버레이의 위치를 마커 위쪽으로 조정
            });
        }


        // 각 카테고리에 클릭 이벤트를 등록합니다
        function addCategoryClickEvent() {
            var category = document.getElementById('category'),
                children = category.children;

            for (var i=0; i<children.length; i++) {
                children[i].onclick = onClickCategory;
            }
        }

        // 카테고리를 클릭했을 때 호출되는 함수입니다
        function onClickCategory() {
            var id = this.id,
                className = this.className;

            placeOverlay.setMap(null);

            if (className === 'on') {
                currCategory = '';
                changeCategoryClass();
                removeCategoryMarker();
            } else {
                currCategory = id;
                changeCategoryClass(this);
                searchPlaces();
            }
        }

        // 클릭된 카테고리에만 클릭된 스타일을 적용하는 함수입니다
        function changeCategoryClass(el) {
            var category = document.getElementById('category'),
                children = category.children,
                i;

            for ( i=0; i<children.length; i++ ) {
                children[i].className = '';
            }

            if (el) {
                el.className = 'on';
            }
        }

        function updatePageWithFilteredEvents(events) {
            // 행사 데이터를 사용하여 웹 페이지를 업데이트하는 코드를 여기에 작성합니다.
            // 예를 들어, Thymeleaf 대신 순수 JavaScript로 DOM을 조작하여
            // 행사 목록을 업데이트할 수 있습니다.

            // 웹 페이지에 행사를 표시하는 로직을 작성합니다.
            const eventsContainer = document.getElementById('eventsContainer');
            eventsContainer.innerHTML = ''; // 기존의 행사 목록을 비웁니다.


            // 받은 행사 데이터를 이용하여 새로운 목록 아이템을 생성합니다.
            events.forEach(event => {

                var item = document.createElement('div');
                item.classList.add('item');

                var imageLink = document.createElement('a');
                imageLink.href = `/eventInfo?title=${encodeURIComponent(event.title)}`;

                var image = document.createElement('img');
                image.src = event.main_IMG;
                image.alt = 'Event Image';

                var title = document.createElement('h4');
                title.innerText = event.title;

                var isFree = document.createElement('p');
                isFree.innerText = event.is_FREE ? '무료' : '유료';
                isFree.classList.add('is-free');

                var imageContainer = document.createElement('div');
                imageLink.appendChild(image);
                imageContainer.appendChild(imageLink);

                var titleContainer = document.createElement('div');
                titleContainer.appendChild(title);
                titleContainer.appendChild(isFree);

                var locationButton = document.createElement('button');
                locationButton.className = 'event-location';
                locationButton.type = 'button';
                locationButton.onclick = function() {
                    moveToLocation(event.lat, event.lot);
                };
                var locationImage = document.createElement('img');
                locationImage.src = "/image/13807908.png";
                locationImage.alt = "위치로딩";
                locationImage.style.width = "25px"; // 이미지 너비 설정
                locationImage.style.height = "25px"; // 이미지 높이 설정
                locationButton.appendChild(locationImage);
                locationButton.style.position = 'absolute';
                locationButton.style.right = '30px';
                locationButton.style.bottom = '15px';
                locationButton.style.width = '25px';
                locationButton.style.height = '25px';
                locationButton.style.background = 'transparent';
                locationButton.style.border = 'none';
                locationButton.style.cursor = 'pointer';


                // eventsContainer에 새로운 행사 아이템을 추가합니다.
                item.appendChild(imageContainer);
                item.appendChild(titleContainer);
                item.appendChild(locationButton);
                eventsContainer.appendChild(item);
            });

            // 이벤트가 없을 때 표시할 메시지입니다.
            if (events.length === 0) {
                var noEventsMsg = document.createElement('p');
                noEventsMsg.innerText = '진행중인 행사가 없습니다.';
                document.getElementById('eventsContainer').appendChild(noEventsMsg);
            }

        }
        function moveToLocation(lat, lng) {
            var moveLatLon = new kakao.maps.LatLng(lng, lat);
            var currentLevel = map.getLevel();
                map.panTo(moveLatLon);
            setTimeout(function() {
            if(currentLevel > 2) {
                map.setLevel(currentLevel-2, {
                    animate: {
                        duration: 500
                    }});}}, 500);
        }

    </script>

</div>


</body>
</html>

